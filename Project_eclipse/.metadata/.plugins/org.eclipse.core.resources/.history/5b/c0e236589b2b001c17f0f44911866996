#include "ultrasonic.h"
#include "icu.h"
#include "gpio.h"
#include <util/delay.h>
static volatile int  g_count=0;
static volatile int  g_hightime=0;
void Ultrasonic_init(void){
	GPIO_setupPinDirection(TRIGGER_PORT,TRIGGER_PIN,PIN_OUTPUT);
	Icu_ConfigType c1 ={F_CPU_8,RISING};
	ICU_init1(&c1);
	ICU_setCallBack(Ultrasonic_edgeProcessing);



}
void Ultrasonic_edgeProcessing(void){
	g_count++;
	if(g_count == 1){
		ICU_clearTimerValue();
		ICU_setEdgeDetectionType(FALLING);


	}

	if(g_count == 2){

		g_hightime=ICU_getInputCaptureValue();
		ICU_clearTimerValue();
		ICU_setEdgeDetectionType(RISING);
		g_count=0;

	}




}
uint16 Ultrasonic_readDistance(void){

	uint16 distance =  (uint16)((g_hightime/58.400000));

	return distance;

}
void Ultrasonic_Trigger(void){
	GPIO_writePin(TRIGGER_PORT,TRIGGER_PIN,LOGIC_HIGH);
	_delay_us(10);
	GPIO_writePin(TRIGGER_PORT,TRIGGER_PIN,LOGIC_LOW);




}
